<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时同步测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; }
        input { padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Supabase 实时同步测试</h1>
    
    <div>
        <h3>测试任务创建</h3>
        <input type="text" id="taskTitle" placeholder="任务标题" value="测试任务">
        <input type="text" id="taskDesc" placeholder="任务描述" value="这是一个测试任务">
        <button onclick="createTestTask()">创建测试任务</button>
        <button onclick="loadTasks()">刷新任务列表</button>
        <button onclick="clearTasks()">清空所有任务</button>
    </div>
    
    <div>
        <h3>当前任务列表</h3>
        <div id="taskList"></div>
    </div>
    
    <div>
        <h3>实时日志</h3>
        <div id="log"></div>
    </div>

    <script src="database.js"></script>
    <script>
        let logDiv = document.getElementById('log');
        let taskListDiv = document.getElementById('taskList');
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log ${type}`;
            entry.innerHTML = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${time}] ${message}`);
        }
        
        async function createTestTask() {
            try {
                const title = document.getElementById('taskTitle').value;
                const description = document.getElementById('taskDesc').value;
                
                log('开始创建测试任务...', 'info');
                
                const taskData = {
                    title: title,
                    description: description,
                    priority: 'medium',
                    alarmEnabled: false,
                    userId: 'test_user'
                };
                
                const newTask = await window.taskDB.createTask(taskData);
                log(`任务创建成功: ${newTask.title} (ID: ${newTask.id})`, 'success');
                
                await loadTasks();
            } catch (error) {
                log(`创建任务失败: ${error.message}`, 'error');
            }
        }
        
        async function loadTasks() {
            try {
                log('加载任务列表...', 'info');
                const tasks = await window.taskDB.getTasks();
                
                taskListDiv.innerHTML = '';
                if (tasks.length === 0) {
                    taskListDiv.innerHTML = '<p>暂无任务</p>';
                } else {
                    tasks.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.style.cssText = 'border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px;';
                        taskDiv.innerHTML = `
                            <strong>${task.title}</strong> (${task.priority})<br>
                            ${task.description}<br>
                            <small>用户: ${task.userId} | 创建时间: ${new Date(task.createdAt).toLocaleString()}</small>
                        `;
                        taskListDiv.appendChild(taskDiv);
                    });
                }
                
                log(`加载完成，共 ${tasks.length} 个任务`, 'success');
            } catch (error) {
                log(`加载任务失败: ${error.message}`, 'error');
            }
        }
        
        async function clearTasks() {
            if (!confirm('确定要删除所有任务吗？')) return;
            
            try {
                const tasks = await window.taskDB.getTasks();
                log(`开始删除 ${tasks.length} 个任务...`, 'info');
                
                for (const task of tasks) {
                    await window.taskDB.deleteTask(task.id);
                }
                
                log('所有任务已删除', 'success');
                await loadTasks();
            } catch (error) {
                log(`删除任务失败: ${error.message}`, 'error');
            }
        }
        
        // 初始化
        async function init() {
            try {
                log('初始化测试页面...', 'info');
                await window.taskDB.initialize();
                log('数据库连接成功', 'success');
                
                // 设置实时监听
                window.taskDB.subscribeToTaskChanges(function(payload) {
                    log(`实时变化: ${payload.eventType} - ${JSON.stringify(payload.new || payload.old)}`, 'info');
                    loadTasks();
                });
                
                log('实时监听已设置', 'success');
                await loadTasks();
            } catch (error) {
                log(`初始化失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>